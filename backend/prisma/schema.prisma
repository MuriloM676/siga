generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  GESTOR
  VISUALIZADOR
}

enum PropertyType {
  CASA
  APARTAMENTO
  COMERCIAL
  TERRENO
  PREDIO
}

enum ContractStatus {
  ATIVO
  ENCERRADO
  CANCELADO
}

enum GuaranteeType {
  CAUCAO
  FIADOR
  SEGURO_FIANCA
  NENHUMA
}

enum IndexType {
  IPCA
  IGP_M
  FIXO
  NENHUM
}

enum PaymentStatus {
  PENDENTE
  PAGO
  ATRASADO
  CANCELADO
}

enum ExpenseType {
  IPTU
  CONDOMINIO
  MANUTENCAO
  SEGURO
  TAXA_IMOBILIARIA
  AGUA
  LUZ
  GAS
  OUTROS
}

enum MaintenanceStatus {
  ABERTO
  EM_ANDAMENTO
  CONCLUIDO
  CANCELADO
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  name          String
  role          Role     @default(VISUALIZADOR)
  refreshToken  String?  @db.Text
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  auditLogs     AuditLog[]

  @@map("users")
}

model Property {
  id          String       @id @default(uuid())
  type        PropertyType
  name        String
  city        String
  state       String
  address     String
  complement  String?
  zipCode     String?
  registration String?     // Matrícula
  observations String?     @db.Text
  
  hasUnits    Boolean      @default(false)
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  units       Unit[]
  contracts   Contract[]
  expenses    Expense[]
  maintenanceTickets MaintenanceTicket[]
  files       FileUpload[]

  @@map("properties")
}

model Unit {
  id          String   @id @default(uuid())
  propertyId  String
  number      String   // Número da unidade (ex: "101", "A", "Sala 5")
  floor       String?
  area        Float?   // Área em m²
  bedrooms    Int?
  bathrooms   Int?
  parkingSpots Int?   @default(0)
  observations String? @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  contracts   Contract[]
  maintenanceTickets MaintenanceTicket[]
  files       FileUpload[]

  @@unique([propertyId, number])
  @@map("units")
}

model Tenant {
  id          String   @id @default(uuid())
  name        String
  cpf         String   @unique
  phone       String?
  email       String?
  address     String?
  observations String? @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  contracts   Contract[]

  @@map("tenants")
}

model Contract {
  id              String         @id @default(uuid())
  propertyId      String
  unitId          String?
  tenantId        String
  
  startDate       DateTime
  endDate         DateTime?
  rentAmount      Float
  dueDay          Int            // Dia de vencimento (1-31)
  
  indexType       IndexType      @default(NENHUM)
  guaranteeType   GuaranteeType  @default(NENHUMA)
  guaranteeDetails String?       @db.Text
  
  status          ContractStatus @default(ATIVO)
  observations    String?        @db.Text
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  property        Property       @relation(fields: [propertyId], references: [id], onDelete: Restrict)
  unit            Unit?          @relation(fields: [unitId], references: [id], onDelete: Restrict)
  tenant          Tenant         @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  
  payments        Payment[]
  files           FileUpload[]

  @@map("contracts")
}

model Payment {
  id              String        @id @default(uuid())
  contractId      String
  
  referenceMonth  DateTime      // Mês de referência (ex: 2024-01-01)
  dueDate         DateTime
  amount          Float
  
  status          PaymentStatus @default(PENDENTE)
  
  paidDate        DateTime?
  paidAmount      Float?
  lateFee         Float?        @default(0)
  interest        Float?        @default(0)
  discount        Float?        @default(0)
  
  observations    String?       @db.Text
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  contract        Contract      @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@unique([contractId, referenceMonth])
  @@map("payments")
}

model Expense {
  id          String      @id @default(uuid())
  propertyId  String
  
  type        ExpenseType
  description String
  amount      Float
  dueDate     DateTime
  paidDate    DateTime?
  isPaid      Boolean     @default(false)
  
  referenceMonth DateTime // Mês de referência
  
  observations String?    @db.Text
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  property    Property   @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  files       FileUpload[]

  @@map("expenses")
}

model MaintenanceTicket {
  id          String            @id @default(uuid())
  propertyId  String
  unitId      String?
  
  title       String
  description String            @db.Text
  cost        Float?            @default(0)
  status      MaintenanceStatus @default(ABERTO)
  
  reportedAt  DateTime          @default(now())
  completedAt DateTime?
  
  observations String?          @db.Text
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  property    Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit        Unit?             @relation(fields: [unitId], references: [id], onDelete: Cascade)
  files       FileUpload[]

  @@map("maintenance_tickets")
}

model FileUpload {
  id                  String             @id @default(uuid())
  fileName            String
  originalName        String
  mimeType            String
  size                Int
  path                String
  
  // Relacionamentos polimórficos
  propertyId          String?
  unitId              String?
  contractId          String?
  expenseId           String?
  maintenanceTicketId String?
  
  uploadedAt          DateTime           @default(now())
  
  property            Property?          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit                Unit?              @relation(fields: [unitId], references: [id], onDelete: Cascade)
  contract            Contract?          @relation(fields: [contractId], references: [id], onDelete: Cascade)
  expense             Expense?           @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  maintenanceTicket   MaintenanceTicket? @relation(fields: [maintenanceTicketId], references: [id], onDelete: Cascade)

  @@map("file_uploads")
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String
  action      String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity      String   // User, Property, Contract, etc.
  entityId    String?
  details     String?  @db.Text // JSON string with changed data
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}
